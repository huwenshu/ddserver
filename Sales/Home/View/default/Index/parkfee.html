<extend name="Public/base"/>

<block name="sidebar"></block>

<block name="style">
    <style>
        body{padding: 0}
        .myborder{
            border: solid 1px #ccc;
            padding-bottom: 5px;
        }
    </style>
</block>

<block name="body">
    <!-- 主体 -->
    <div id="indexMain" class="index-main">
  	<table style="display: flex">
      <tr>
          <td><label for="parkname">停车场名称：</label></td>
          <td style="width: 100px"><input type="text" id="parkname" name="name" value="{$parkname}" /></td>
      </tr>
      <tr>
          <td colspan="2">
              <textarea id="chargingrules" name="chargingrules" rows="3" style="width: 700px">{$rules}</textarea>
          </td>
      </tr>
    </table>
    <form action="{$formurl}" method="post" id="ruleform">
    <input type="hidden"  name="id" value="{$parkid}" /> 
    <input type="hidden" id="ruleid" name="ruleid" value="" /> 
    <input type="hidden" id="ruleop" name="ruleop" value="" /> 
		</form>
		<div>
    <table style="display: flex">
    	<tr><td width="300px"><b>计费规则库</b></td><td><b>时间/费用</b></td></tr>
    </table>
    <?php
	    foreach($rulesdata as $index => $value){
	    	echo '<table style="display: flex">
					      <tr>
					          <td width="300px" style="border:2px solid"><input type="hidden" class="ruleid" value="'.$value['id'].'" /> <button type="button" class="delrule">删除</button>&nbsp<input type="text" class="starttime" name="starttime" value="'.$value['startime'].'" style="width:100px"/>到<input type="text" class="endtime" name="endtime" value="'.$value['endtime'].'" style="width:100px"/></td>
					          <td style="border:2px solid">
					          	<ul>';
				$con1 = "rulesid=".$value['id'];
				$moneydata = $rulesmoney->where($con1)->order('mins')->select();
				foreach($moneydata as $index1=>$value1){
					echo '<li><button type="button" class="delruletime">删除</button>&nbsp<select class="ruletype" name="ruletype" style="width: 100px"><option value="1">小于等于</option><option value="2">到截止时间</option></select><span class="rule1disp"><input type="text" class="rulemins" value="'.$value1['mins'].'" style="width:70px;"/>分钟</span>，费用为<input type="text" class="rulefee" value="'.$value1['money'].'" style="width:60px;"/>元</li>';
				}
				echo '</ul>
					          	<button type="button" class="addruletime">添加费用</button><button type="button" class="saverule">保存本条规则</button>
					          </td>
					      </tr>
					    </table>';
	    }
    ?>
  	</div>
		<button type="button" class="addrule">添加计费规则</button>
      
    </div>
</block>

<block name="script">
<script type="text/javascript">
	var newrule = 0;
	function delruletime(){
		$(this).parent().remove();
	}
	function changeruletype(){
		//$(this).parent().find(".rule1disp").toggle();
    $(this).val("1");
    alert("尚不支持该模式，如果遇到此类案例，请联系开发团队！");
	}
	function delrule(){
		var ruleid = $(this).parent().find(".ruleid").val();
		if(ruleid == 0){
			$(this).parent().parent().parent().remove();
			newrule = 0;
		}else{
			$("#ruleid").val(ruleid);
			$("#ruleform").submit();
		}
	}
	function saverule(){
		var ruleid = $(this).parent().prev().find(".ruleid").val();
		var starttime = $(this).parent().prev().find(".starttime").val();
		var endtime = $(this).parent().prev().find(".endtime").val();
		var ruleop = starttime+";"+endtime;
		$(this).parent().find("li").each(function(li){
			//console.log($(this));
			ruleop+=";"+$(this).find(".rulemins").val()+","+$(this).find(".rulefee").val();
		});
		$("#ruleid").val(ruleid);
		$("#ruleop").val(ruleop);
		$("#ruleform").submit();
	}
	function addruletime(){
		var temp = '<li><button type="button" class="delruletime">删除</button>&nbsp<select class="ruletype" name="ruletype" style="width: 100px"><option value="1">小于等于</option><option value="2">到截止时间</option></select><span class="rule1disp"><input type="text" class="rulemins" value="1800" style="width:70px;"/>分钟</span>，费用为<input type="text" class="rulefee" value="10" style="width:60px;"/>元</li>';
    var row = $(temp);
    row.find('.delruletime').click(delruletime);
    row.find('.ruletype').change(changeruletype);
    
    $(this).prev().append(row);
	}
	function addrule(){
		if(newrule == 1){
			alert("请先保存之前创建的新规则！");
			return;
		}
		else{
			newrule = 1;
		}
		var temp = '<table style="display: flex"><tr><td width="300px" style="border:2px solid"><input type="hidden" class="ruleid" value="0" /> <button type="button" class="delrule">删除</button>&nbsp<input type="text" class="starttime" name="starttime" value="00:00:00" style="width:100px"/>到<input type="text" class="endtime" name="endtime" value="23:59:59" style="width:100px"/></td><td style="border:2px solid"><ul><li><button type="button" class="delruletime">删除</button>&nbsp<select class="ruletype" name="ruletype" style="width: 100px"><option value="1">小于等于</option><option value="2">到截止时间</option></select><span class="rule1disp"><input type="text" class="rulemins" value="1800" style="width:70px;"/>分钟</span>，费用为<input type="text" class="rulefee" value="10" style="width:60px;"/>元</li></ul><button type="button" class="addruletime">添加费用</button><button type="button" class="saverule">保存本条规则</button></td></tr></table>';
    var row = $(temp);
    row.find('.addruletime').click(addruletime);
    row.find('.delruletime').click(delruletime);
    row.find('.ruletype').change(changeruletype);
    row.find('.delrule').click(delrule);
    row.find('.saverule').click(saverule);
    
    $(this).prev().append(row);
	}
	
    $(function(){
        $('.sidebar').remove();
        
        $('.addruletime').click(addruletime);
        $('.delruletime').click(delruletime);
        $('.ruletype').change(changeruletype);
        $('.delrule').click(delrule);
       	$('.saverule').click(saverule);
        $('.addrule').click(addrule);
    })
</script>
</block>